###
# This config.yml was generated by docker-etl/ci_config.py.
# Changes should be made to templates/config.template.yml and re-generated.
###
version: 2.1

parameters:
  docker-version:
    type: string
    # `default` is recommended by CircleCI: https://discuss.circleci.com/t/remote-docker-image-deprecations-and-eol-for-2024/50176#what-do-i-need-to-do-2
    default: default
  git-image:
    type: string
    default: docker:25.0.3-git

orbs:
  gcp-gcr: circleci/gcp-gcr@0.16.2

commands:
  compare-branch:
    description: Compare current branch with main
    parameters:
      pattern:
        type: string
    steps:
      - run:
          name: Compare current branch with main
          command: |
            if [ "$CIRCLE_BRANCH" = main ]; then
                echo "Run tests because branch is main"
            elif git log --format=%B --no-merges -n 1 | grep -qF '[run-tests]'; then
                echo "Run tests because [run-tests] in commit message"
            elif git diff --name-only ..origin | egrep -q '<< parameters.pattern >>'; then
                echo "Run tests because << parameters.pattern >> was modified since branching off main"
            else
                echo "Skipping tests because << parameters.pattern >> was not modified"
                circleci step halt
            fi

jobs:
  build-docker-etl:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - run:
          name: Checkout git submodules
          command: git submodule update --init --recursive
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t docker-etl:build .
      - run:
          name: Test Code
          command: |
            docker run docker-etl:build /bin/bash -c \
            "python -m pytest docker_etl/ tests/; \
            flake8 docker_etl/ tests/;\
            black docker_etl/ tests/"
      - run:
          name: Verify jobs have required files
          command: docker run docker-etl:build script/verify_files
      - run:
          name: Verify CI config is up-to-date
          command: docker run docker-etl:build python3 -m docker_etl.ci_config --dry-run | diff -B .circleci/config.yml -

  build-job-bq2sftp:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/bq2sftp/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/bq2sftp/

  build-job-broken-site-report-ml:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/broken-site-report-ml/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/broken-site-report-ml/
      - run:
          name: Test Code
          command: docker run app:build pytest --flake8 --black

  build-job-client-regeneration:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/client-regeneration/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/client-regeneration/
      - run:
          name: Test Code
          command: docker run app:build pytest --flake8 --black

  build-job-dap-collector:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/dap-collector/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/dap-collector/

  build-job-dap-collector-ppa-dev:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/dap-collector-ppa-dev/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/dap-collector-ppa-dev/

  build-job-dap-collector-ppa-prod:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/dap-collector-ppa-prod/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/dap-collector-ppa-prod/

  build-job-desktop-mobile-mau-2020:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/desktop-mobile-mau-2020/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/desktop-mobile-mau-2020/
      - run:
          name: Test Code
          command: docker run app:build pytest --flake8 --black

  build-job-eam-integrations:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/eam-integrations/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/eam-integrations/

  build-job-example_job:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/example_job/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/example_job/


  build-job-experiments-monitoring-data-export:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/experiments-monitoring-data-export/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/experiments-monitoring-data-export/


  build-job-influxdb-to-bigquery:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/influxdb-to-bigquery/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/influxdb-to-bigquery/


  build-job-kpi-forecasting:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/kpi-forecasting/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/kpi-forecasting/
      - run:
          name: Test Code
          command: docker run app:build pytest --ruff --ruff-format


  build-job-mozaggregator2bq:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/mozaggregator2bq/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/mozaggregator2bq/


  build-play-store-export:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/play-store-export/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/play-store-export
      - run:
          name: Test Code
          command: docker run app:build make test
      - run:
          name: Lint Code
          command: docker run app:build make lint


  build-job-quicksuggest2bq:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/quicksuggest2bq/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/quicksuggest2bq/
      - run:
          name: Test Code
          command: docker run app:build pytest --flake8 --black
      - run:
          name: Lint Code
          command: docker run app:build flake8


  build-job-search-alert:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/search-alert/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/search-alert/


  build-job-search-term-data-validation-v2:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/search-term-data-validation-v2/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/search-term-data-validation-v2/
      - run:
          name: Test Code
          command: docker run app:build pytest


  build-job-webcompat-kb:
    docker:
      - image: << pipeline.parameters.git-image >>
    steps:
      - checkout
      - compare-branch:
          pattern: ^jobs/webcompat-kb/
      - setup_remote_docker:
          version: << pipeline.parameters.docker-version >>
      - run:
          name: Build Docker image
          command: docker build -t app:build jobs/webcompat-kb/
      - run:
          name: Test Code
          command: docker run app:build pytest --ruff --ruff-format


workflows:
  docker-etl:
    jobs:
      - build-docker-etl

  job-bq2sftp:
    jobs:
      - build-job-bq2sftp
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/bq2sftp/
          path: jobs/bq2sftp/
          image: bq2sftp_docker_etl
          requires:
            - build-job-bq2sftp
          filters:
            branches:
              only: main


  job-broken-site-report-ml:
    jobs:
      - build-job-broken-site-report-ml
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/broken-site-report-ml/
          path: jobs/broken-site-report-ml/
          image: broken-site-report-ml_docker_etl
          requires:
            - build-job-broken-site-report-ml
          filters:
            branches:
              only: main

  job-client-regeneration:
    jobs:
      - build-job-client-regeneration
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/client-regeneration/
          path: jobs/client-regeneration/
          image: client-regeneration_docker_etl
          requires:
            - build-job-client-regeneration
          filters:
            branches:
              only: main

  job-dap-collector:
    jobs:
      - build-job-dap-collector
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/dap-collector/
          path: jobs/dap-collector/
          image: dap-collector_docker_etl
          requires:
            - build-job-dap-collector
          filters:
            branches:
              only: main

  job-dap-collector-ppa-dev:
    jobs:
      - build-job-dap-collector-ppa-dev
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/dap-collector-ppa-dev/
          path: jobs/dap-collector-ppa-dev/
          image: dap-collector-ppa-dev_docker_etl
          requires:
            - build-job-dap-collector-ppa-dev
          filters:
            branches:
              only: main

  job-dap-collector-ppa-prod:
    jobs:
      - build-job-dap-collector-ppa-prod
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/dap-collector-ppa-prod/
          path: jobs/dap-collector-ppa-prod/
          image: dap-collector-ppa-prod_docker_etl
          requires:
            - build-job-dap-collector-ppa-prod
          filters:
            branches:
              only: main

  job-desktop-mobile-mau-2020:
    jobs:
      - build-job-desktop-mobile-mau-2020

  job-eam-integrations:
    jobs:
      - build-job-eam-integrations
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/eam-integrations/
          path: jobs/eam-integrations/
          image: eam-integrations_docker_etl
          requires:
            - build-job-eam-integrations
          filters:
            branches:
              only: main

  job-example_job:
    jobs:
      - build-job-example_job
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          path: jobs/example_job/
          image: example_job_docker_etl
          requires:
            - build-job-example_job
          filters:
            branches:
              only: main


  job-experiments-monitoring-data-export:
    jobs:
      - build-job-experiments-monitoring-data-export
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/experiments-monitoring-data-export/
          path: jobs/experiments-monitoring-data-export/
          image: experiments-monitoring-data-export_docker_etl
          requires:
            - build-job-experiments-monitoring-data-export
          filters:
            branches:
              only: main

  job-influxdb-to-bigquery:
    jobs:
      - build-job-influxdb-to-bigquery
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/influxdb-to-bigquery/
          path: jobs/influxdb-to-bigquery/
          image: influxdb-to-bigquery_docker_etl
          requires:
            - build-job-influxdb-to-bigquery
          filters:
            branches:
              only: main


  job-kpi-forecasting:
    jobs:
      - build-job-kpi-forecasting
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/kpi-forecasting/
          path: jobs/kpi-forecasting/
          image: kpi-forecasting_docker_etl
          requires:
            - build-job-kpi-forecasting
          filters:
            branches:
              only: main


  job-mozaggregator2bq:
    jobs:
      - build-job-mozaggregator2bq
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/mozaggregator2bq/
          path: jobs/mozaggregator2bq/
          image: mozaggregator2bq_docker_etl
          requires:
            - build-job-mozaggregator2bq
          filters:
            branches:
              only: main


  play-store-export:
    jobs:
      - build-play-store-export
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/play-store-export/
          path: jobs/play-store-export/
          image: play-store-export
          requires:
            - build-play-store-export
          filters:
            branches:
              only: main


  job-quicksuggest2bq:
    jobs:
      - build-job-quicksuggest2bq
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/quicksuggest2bq/
          path: jobs/quicksuggest2bq/
          image: quicksuggest2bq_docker_etl
          requires:
            - build-job-quicksuggest2bq
          filters:
            branches:
              only: main


  job-search-alert:
    jobs:
      - build-job-search-alert
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/search-alert/
          path: jobs/search-alert/
          image: search-alert_docker_etl
          requires:
            - build-job-search-alert
          filters:
            branches:
              only: main

  job-search-term-data-validation-v2:
    jobs:
      - build-job-search-term-data-validation-v2
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/search-term-data-validation-v2/
          path: jobs/search-term-data-validation-v2/
          image: search-term-data-validation-v2_docker_etl
          requires:
            - build-job-search-term-data-validation-v2
          filters:
            branches:
              only: main

  job-webcompat-kb:
    jobs:
      - build-job-webcompat-kb
      - gcp-gcr/build-and-push-image:
          context: data-eng-airflow-gcr
          docker-context: jobs/webcompat-kb/
          path: jobs/webcompat-kb/
          image: webcompat-kb_docker_etl
          requires:
            - build-job-webcompat-kb
          filters:
            branches:
              only: main
